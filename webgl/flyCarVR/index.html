<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <title>JC_demo</title>
    <style type="text/css">
    * {
        padding: 0;
        margin: 0;
    }
    
    body {
        position: relative;
        overflow: hidden;
        background-color: #8bf2ff;
    }
    
    .vr-btn {
        position: absolute;
        top: 0;
        right: 0;
        z-index: 20;
        min-width: .5rem;
        min-height: .3rem;
        padding-right: 5%;
        padding-top: 4%;
        background: url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20245.82%20141.73%22%3E%3Cdefs%3E%3Cstyle%3E.a%7Bfill%3A%23fff%3Bfill-rule%3Aevenodd%3B%7D%3C%2Fstyle%3E%3C%2Fdefs%3E%3Ctitle%3Emask%3C%2Ftitle%3E%3Cpath%20class%3D%22a%22%20d%3D%22M175.56%2C111.37c-22.52%2C0-40.77-18.84-40.77-42.07S153%2C27.24%2C175.56%2C27.24s40.77%2C18.84%2C40.77%2C42.07S198.08%2C111.37%2C175.56%2C111.37ZM26.84%2C69.31c0-23.23%2C18.25-42.07%2C40.77-42.07s40.77%2C18.84%2C40.77%2C42.07-18.26%2C42.07-40.77%2C42.07S26.84%2C92.54%2C26.84%2C69.31ZM27.27%2C0C11.54%2C0%2C0%2C12.34%2C0%2C28.58V110.9c0%2C16.24%2C11.54%2C30.83%2C27.27%2C30.83H99.57c2.17%2C0%2C4.19-1.83%2C5.4-3.7L116.47%2C118a8%2C8%2C0%2C0%2C1%2C12.52-.18l11.51%2C20.34c1.2%2C1.86%2C3.22%2C3.61%2C5.39%2C3.61h72.29c15.74%2C0%2C27.63-14.6%2C27.63-30.83V28.58C245.82%2C12.34%2C233.93%2C0%2C218.19%2C0H27.27Z%22%2F%3E%3C%2Fsvg%3E) 50% 50%/70% 70% no-repeat rgba(0, 0, 0, .35);
    }
    
    .aboard-car {
        position: absolute;
        top: 40%;
        left: 50%;
        width: 100px;
        height: 30px;
        margin: -15px 0 0 -50px;
        background-color: #ff0;
        border-radius: 6px;
        line-height: 30px;
        text-align: center;
        z-index: 2;
    }
    .fullscreen-btn {
        position: absolute;
        right: 0;
        top: 12%;
        min-width: .5rem;
        min-height: .3rem;
        padding-right: 5%;
        padding-top: 4%;
        background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDQ4OC40IDQ4OC40IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0ODguNCA0ODguNDsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSI1MTJweCIgaGVpZ2h0PSI1MTJweCI+PGc+PHBvbHlnb24gcG9pbnRzPSI0NDEuMSw0MDcuOCAzMzguOCwzMDUuNSAzMDUuNSwzMzguOCA0MDcuOCw0NDEuMSAzMjguMyw0NDEuMSAzMjguMyw0ODguNCA0ODguNCw0ODguNCA0ODguNCwzMjguMyA0NDEuMSwzMjguMyAgICAgICAgICIgZmlsbD0iI2ZmZmZmZiIvPjxwb2x5Z29uIHBvaW50cz0iMzM4LjgsMTgzIDQ0MS4xLDgwLjYgNDQxLjEsMTYwLjEgNDg4LjQsMTYwLjEgNDg4LjQsMCAzMjguMywwIDMyOC4zLDQ3LjMgNDA3LjgsNDcuMyAzMDUuNSwxNDkuNiAgICAiIGZpbGw9IiNmZmZmZmYiLz48cG9seWdvbiBwb2ludHM9IjE0OS42LDMwNS41IDQ3LjMsNDA3LjggNDcuMywzMjguMyAwLDMyOC4zIDAsNDg4LjQgMTYwLjEsNDg4LjQgMTYwLjEsNDQxLjEgODAuNiw0NDEuMSAxODMsMzM4LjggICAgIiBmaWxsPSIjZmZmZmZmIi8+PHBvbHlnb24gcG9pbnRzPSIxNjAuMSw0Ny4zIDE2MC4xLDAgMCwwIDAsMTYwLjEgNDcuMywxNjAuMSA0Ny4zLDgwLjYgMTQ5LjYsMTgzIDE4MywxNDkuNiA4MC42LDQ3LjMgICAgIiBmaWxsPSIjZmZmZmZmIi8+PC9nPjwvc3ZnPg==) 50% 50%/70% 70% no-repeat rgba(0, 0, 0, .35);
    }
    </style>
</head>

<body>
<canvas id="webgl"></canvas>
<div class="vr-btn" id="vrBtn"></div>
<div class="fullscreen-btn" id="fullscreenBtn"></div>
<div class="aboard-car" id="aboardCar">上车</div>
<script type="text/javascript" src="./js/three.js"></script>
<script type="text/javascript" src="./js/MTLLoader.js"></script>
<script type="text/javascript" src="./js/OBJLoader.js"></script>
<script type="text/javascript" src="./js/NURBSCurve.js"></script>
<script type="text/javascript" src="./js/NURBSUtils.js"></script>
<script type="text/javascript" src="./js/TweenMax.min.js"></script>
<script type="text/javascript" src="./js/StereoEffect.js"></script>
<script type="text/javascript" src="./js/DeviceOrientationControls.js"></script>
<script type="text/javascript" src="./js/NurbsPath.js"></script>
<script type="text/javascript" src="./js/ground.js"></script>
<script type="text/javascript" src="./js/roadScene.js"></script>
<script type="text/javascript">

window.addEventListener('resize', onWindowResize, false);

var WIDTH = window.innerWidth;
var HEIGHT = window.innerHeight;
var vrRender = false;

var camera = new THREE.PerspectiveCamera(90, WIDTH / HEIGHT, 1, 2000);
camera.position.z = 300;
camera.position.y = 1;
camera.lookAt(new THREE.Vector3(0.0, 1.0, -50.0));

// camera.position.x = 30;
// camera.position.y = 2;
// camera.position.z = -4;
// camera.lookAt(new THREE.Vector3(0, 2, -4));

var controls = new THREE.DeviceOrientationControls(camera);

var renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById('webgl')
});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(WIDTH, HEIGHT);
renderer.setClearColor(0x8bf2ff);

var effect = new THREE.StereoEffect(renderer);


var scene = new THREE.Scene();
var ground = new Ground({
    land: {
        w: 2000,
        h: 2000,
        color: 0xd6d6d6
    },
    road: {
        w: 80,
        color: 0x4a4a4a
    },
    markings: {
        w: 2,
        space: 2,
        color: 0xffffff
    }
});
scene.add(ground.doc);

var roadScene = new RoadScene();
scene.add(roadScene.doc);

var ambient = new THREE.AmbientLight(0xaaaaaa);
scene.add(ambient);

var directionalLight = new THREE.DirectionalLight(0xffffff);
directionalLight.position.set(0, 100, 100).normalize();
scene.add(directionalLight);

var car = null;
var mtlLoader = new THREE.MTLLoader();
mtlLoader.setPath('./model/');
mtlLoader.load('car7.mtl', function(materials) {
    materials.preload();
    var objLoader = new THREE.OBJLoader();
    // console.log(materials);
    objLoader.setMaterials(materials);
    objLoader.setPath('./model/');
    objLoader.load('car7.obj', function(object) {
        car = object;
        // var ms = car.children[0].material.materials;
        for (var i = 0; i < car.children.length; i++) {
            var tool = car.children[i];
            for (var j = 0; j < tool.material.materials.length; j++) {
                var ms = tool.material.materials[j];
                // console.log(ms);
                ms.side = THREE.DoubleSide;
            }
        }
        carStats.wheelF = car.children[0];
        carStats.wheelB = carStats.wheelF.clone();
        carStats.wheelF.position.set(0, 0.5, 2.25);
        carStats.wheelB.position.set(0, 0.5, -2.25);
        car.add(carStats.wheelB);
        // car.children[0].material.materials[0].side = THREE.DoubleSide;
        // car.children[0].material.materials[1].side = THREE.DoubleSide;
        // car.children[0].material.materials[2].side = THREE.DoubleSide;
        // car.children[0].material.materials[3].side = THREE.DoubleSide;
        // car.children[0].material.materials[4].side = THREE.DoubleSide;
        // car.children[0].material.materials[5].side = THREE.DoubleSide;
        car.rotation.y = Math.PI;
        car.position.z = -8;
        car.scale.set(5, 5, 5);
        scene.add(car);

        carStats.car = car;
    });
});

var moveEnd = false;
var nurbsPath = new NurbsPath();

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    RAF(animate);
    render();
}

function render() {
    if (moveEnd) {
        upSpeed();
        goPos();
        carStats.update();
    }
    if (carStats.car) {
        carStats.wheelB.rotation.x = carStats.wheelF.rotation.x = (carStats.wheelF.rotation.x + roadScene.timeScale * 0.17) % Math.PI;
        // console.log( roadScene.timeScale);
    }

    if (!vrRender) {
        renderer.render(scene, camera);
    } else {
        if (moveEnd) {
            controls.update();
        }
        effect.render(scene, camera);
    }
}

var carStats = new CarStats({
    car: null,
    camera: camera,
    roadScene: roadScene,
    control: controls
});


function CarStats(options) {
    options = options || {};
    this.roadScene = options.roadScene;
    this.camera = options.camera;
    this.car = options.car;
    this.stats = options.control;

}
CarStats.prototype.update = function() {
    if (!this.car) return;
    this.fix();

    this.car.rotation.y = Math.PI - THREE.Math.degToRad(this.rotateZ) * 0.6;
    this.camera.position.x = this.car.position.x = THREE.Math.clamp(this.car.position.x + this.rotateZ * 0.05, -32, 32);
    if (this.rotateX < -10) {
        this.roadScene.speedUp();
    } else if (this.rotateX > 10) {
        this.roadScene.speedDown();
    }
};
CarStats.prototype.fix = function() {
    var flipX = this.stats.deviceOrientation.gamma < 0 ? -1 : 1;
    var flipY = this.stats.deviceOrientation.beta < 0 ? -1 : 1;
    switch (this.stats.screenOrientation) {
        case 0:
            this.rotateX = this.stats.deviceOrientation.beta - 90;
            this.rotateZ = this.rotateX > 0 ? -this.stats.deviceOrientation.gamma : this.stats.deviceOrientation.gamma;
            break;
        case 90:
            this.rotateX = flipX * (90 - Math.abs(this.stats.deviceOrientation.gamma));
            this.rotateZ = this.rotateX > 0 ? flipY * (180 - Math.abs(this.stats.deviceOrientation.beta)) : this.stats.deviceOrientation.beta;
            break;
        case -90:
            this.rotateX = -flipX * (90 - Math.abs(this.stats.deviceOrientation.gamma));
            this.rotateZ = this.rotateX > 0 ? -flipY * (180 - Math.abs(this.stats.deviceOrientation.beta)) : -this.stats.deviceOrientation.beta;
            break;
    }
};

animate();




renderer.domElement.addEventListener('click', function() {
    if (vrRender) {
        vrRender = false;
        exitFullscreen();
        vrBtn.style.display = 'block';
        fullBtn.style.display = 'block';
        camera.lookAt(new THREE.Vector3(0.0, 1.0, -50.0));
        onWindowResize();
    }
});
var vrBtn = document.getElementById('vrBtn');
vrBtn.addEventListener('click', function() {
        launchFullScreen(document.body);
        vrRender = true;
        vrBtn.style.display = 'none';
        fullBtn.style.display = 'none';
});
var fullBtn = document.getElementById('fullscreenBtn');
fullBtn.addEventListener('click', function() {
    if (!fullBtn.inFull) {
        launchFullScreen(document.body);
        fullBtn.inFull = true;
    } else {
        exitFullscreen();
        fullBtn.inFull = false;
    }
});
var carBtn = document.getElementById('aboardCar');
carBtn.addEventListener('click', function(event) {
    if (car !== null) {
        var t = 5;
        carBtn.innerHTML = t;
        var timer = setInterval(function(){
            carBtn.innerHTML = --t;
        }, 1000);
        setTimeout(function(){
            carBtn.style.display = 'none';
            nurbsPath.motion(
                8000,
                'linear',
                function(point, t) {
                    camera.position.x = point.x;
                    camera.position.y = point.y;
                    camera.position.z = point.z;
                    camera.lookAt(lookAtCurve.getPoint(t));
                },
                function() {
                    camera.position.set(0, 12, -8);
                    camera.lookAt(new THREE.Vector3( 0,1,-50 ));
                    moveEnd = true;
                    if (vrRender) {
                        controls.updateAlphaOffsetAngle(Math.PI/2);
                    }
                }
            );
        },5e3);
    }
}, false);

function launchFullScreen(element) {
    if (element.requestFullscreen) {
        element.requestFullscreen();
    } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
    } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
    }
}

function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    }
}






var speedClock = false,
    dirClock = false,
    speedTo = '',
    dirTo = '';
document.addEventListener('keydown', function(ev) {
    // console.log(ev.keyCode);// ArrowLeft 37    ArrowRight 39    ArrowUp 38    ArrowDown  40
    switch (ev.keyCode) {
        case 37:
            dirTo = 'ArrowLeft';
            break;
        case 39:
            dirTo = 'ArrowRight';
            break;
        case 38:
            speedTo = 'ArrowUp';
            break;
        case 40:
            speedTo = 'ArrowDown';
            break;
    }
});
document.addEventListener('keyup', function(ev) {
    // console.log(ev);
    switch (ev.keyCode) {
        case 37:
            if (dirTo === 'ArrowLeft') dirTo = '';
            break;
        case 39:
            if (dirTo === 'ArrowRight') dirTo = '';
            break;
        case 38:
            if (speedTo === 'ArrowUp') speedTo = '';
            break;
        case 40:
            if (speedTo === 'ArrowDown') speedTo = '';
            break;
    }
});


function goPos() {
    if (dirTo === 'ArrowRight') {
        camera.position.x = car.position.x = THREE.Math.clamp(car.position.x + 0.5, -32, 32);
    }
    if (dirTo === 'ArrowLeft') {
        camera.position.x = car.position.x = THREE.Math.clamp(car.position.x - 0.5, -32, 32);
    }
}

function upSpeed() {
    if (speedTo === 'ArrowUp') {
        roadScene.speedUp(0.06);
    }
    if (speedTo === 'ArrowDown') {
        roadScene.speedDown();
    }
}
</script>
</body>

</html>
